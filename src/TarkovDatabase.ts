/*
* Basing the below class 'TarkovProfileInstance' on this data....
*
* {"id":"5a5138265e9d88686c17bd4d","aid":1161290,"info":{"nickname":"CharacterOverfl","side":"Bear","experience":1161114,"memberCategory":2,"bannedState":false,"bannedUntil":0,"registrationDate":1703727565},"customization":{"head":"5fdb50bb2b730a787b3f78cf","body":"657058fddf9b3231400e9188","feet":"65707a89f5a6f1412f0c5f7b","hands":"6572eafead200ced8e0f051a"},"skills":{"Common":[{"Id":"BotReload","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":-2147483648},{"Id":"BotSound","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":-2147483648},{"Id":"Endurance","Progress":1018.64142,"PointsEarnedDuringSession":0,"LastAccess":1710565010},{"Id":"Strength","Progress":1762.49451,"PointsEarnedDuringSession":0,"LastAccess":1710647186},{"Id":"Vitality","Progress":454.340546,"PointsEarnedDuringSession":0,"LastAccess":1710647192},{"Id":"Health","Progress":1206.67834,"PointsEarnedDuringSession":0,"LastAccess":1710647192},{"Id":"StressResistance","Progress":492.7188,"PointsEarnedDuringSession":0,"LastAccess":1710472105},{"Id":"Metabolism","Progress":3019.51123,"PointsEarnedDuringSession":0,"LastAccess":1710473367},{"Id":"Immunity","Progress":497.952423,"PointsEarnedDuringSession":0,"LastAccess":1710472202},{"Id":"Perception","Progress":1232.79443,"PointsEarnedDuringSession":0,"LastAccess":1710473494},{"Id":"Intellect","Progress":106,"PointsEarnedDuringSession":0,"LastAccess":1710297116},{"Id":"Attention","Progress":839.032166,"PointsEarnedDuringSession":0,"LastAccess":1710473491},{"Id":"Charisma","Progress":825.242,"PointsEarnedDuringSession":0,"LastAccess":1710647287},{"Id":"Memory","Progress":940.329346,"PointsEarnedDuringSession":0,"LastAccess":1710647192},{"Id":"Pistol","Progress":195.171,"PointsEarnedDuringSession":0,"LastAccess":1707177672},{"Id":"Revolver","Progress":25.5122375,"PointsEarnedDuringSession":0,"LastAccess":1709174301},{"Id":"SMG","Progress":395.3027,"PointsEarnedDuringSession":0,"LastAccess":1710644982},{"Id":"Assault","Progress":341.27948,"PointsEarnedDuringSession":0,"LastAccess":1710294085},{"Id":"Shotgun","Progress":149.604736,"PointsEarnedDuringSession":0,"LastAccess":1709174911},{"Id":"Sniper","Progress":141.129868,"PointsEarnedDuringSession":0,"LastAccess":1710105537},{"Id":"LMG","Progress":144.86171,"PointsEarnedDuringSession":0,"LastAccess":1710472087},{"Id":"HMG","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Launcher","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"AttachedLauncher","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Throwing","Progress":81.19138,"PointsEarnedDuringSession":0,"LastAccess":1710646923},{"Id":"Melee","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"DMR","Progress":119.854294,"PointsEarnedDuringSession":0,"LastAccess":1710038196},{"Id":"RecoilControl","Progress":722.11554,"PointsEarnedDuringSession":0,"LastAccess":1710645086},{"Id":"AimDrills","Progress":250.62796,"PointsEarnedDuringSession":0,"LastAccess":1710472079},{"Id":"TroubleShooting","Progress":15.8,"PointsEarnedDuringSession":0,"LastAccess":1704250738},{"Id":"Surgery","Progress":336.35,"PointsEarnedDuringSession":0,"LastAccess":1710472197},{"Id":"CovertMovement","Progress":381.7702,"PointsEarnedDuringSession":0,"LastAccess":1710647133},{"Id":"Search","Progress":797.4555,"PointsEarnedDuringSession":0,"LastAccess":1710473491},{"Id":"MagDrills","Progress":301.328461,"PointsEarnedDuringSession":0,"LastAccess":1710645067},{"Id":"Sniping","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"ProneMovement","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"FieldMedicine","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"FirstAid","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"LightVests","Progress":212.55809,"PointsEarnedDuringSession":0,"LastAccess":1710647192},{"Id":"HeavyVests","Progress":103.94519,"PointsEarnedDuringSession":0,"LastAccess":1710472086},{"Id":"WeaponModding","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"AdvancedModding","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"NightOps","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"SilentOps","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Lockpicking","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"WeaponTreatment","Progress":48,"PointsEarnedDuringSession":0,"LastAccess":1710291324},{"Id":"Freetrading","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Auctions","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Cleanoperations","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Barter","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Shadowconnections","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Taskperformance","Progress":0,"PointsEarnedDuringSession":0,"LastAccess":0},{"Id":"Crafting","Progress":603.29,"PointsEarnedDuringSession":0,"LastAccess":1710633480},{"Id":"HideoutManagement","Progress":462.29,"PointsEarnedDuringSession":0,"LastAccess":1710633436}],"Mastering":[{"Id":"MP443","Progress":6},{"Id":"PPSH","Progress":82},{"Id":"M590","Progress":5},{"Id":"PP19","Progress":77},{"Id":"AK74","Progress":279},{"Id":"MP153","Progress":98},{"Id":"GLOCK17","Progress":260},{"Id":"MP5","Progress":60},{"Id":"MP9","Progress":1},{"Id":"mosin","Progress":2},{"Id":"SKS","Progress":2},{"Id":"MDR","Progress":25},{"Id":"AKSU","Progress":36},{"Id":"AUG","Progress":9},{"Id":"AKM","Progress":6},{"Id":"VSS","Progress":0},{"Id":"MK47","Progress":22},{"Id":"mp7","Progress":0},{"Id":"SVD","Progress":9},{"Id":"M1A","Progress":24},{"Id":"M4","Progress":79},{"Id":"m1911","Progress":0},{"Id":"VPO_215","Progress":0},{"Id":"MPX","Progress":171},{"Id":"STM-9","Progress":107},{"Id":"SV98","Progress":68},{"Id":"m9","Progress":0},{"Id":"MCX","Progress":94},{"Id":"SVT-40","Progress":18},{"Id":"MP-18","Progress":4},{"Id":"RFB","Progress":8},{"Id":"P90","Progress":335},{"Id":"RSH12","Progress":14},{"Id":"RHINO","Progress":1},{"Id":"PP-91","Progress":7},{"Id":"Mk17","Progress":11},{"Id":"MR43","Progress":6},{"Id":"SAIGA","Progress":0},{"Id":"AXMC","Progress":1},{"Id":"RPD","Progress":151},{"Id":"ASH12","Progress":9},{"Id":"SA-58","Progress":34},{"Id":"SR25","Progress":22},{"Id":57,"Progress":0},{"Id":"r700","Progress":0},{"Id":"MTS","Progress":0}],"Points":0},"equipment":{"Id":"658cd1cdaee208d8ed087909","Items":[{"_id":"658cd1cdaee208d8ed087909","_tpl":"55d7217a4bdc2d86028b456d"},{"_id":"658cd1cdaee208d8ed0878f9","_tpl":"5857a8bc2459772bad15db29","parentId":"658cd1cdaee208d8ed087909","slotId":"SecuredContainer"},{"_id":"65b039a82af2e547a20f46c7","_tpl":"619cbf7d23893217ec30b689","parentId":"658cd1cdaee208d8ed0878f9","slotId":"main","location":{"x":2,"y":0,"r":0,"isSearched":true}},{"_id":"65be7592f2c9b0456d0203f9","_tpl":"637b6179104668754b72f8f5","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":2,"y":2,"r":0,"isSearched":true}},{"_id":"65dfebd47dbdfc2dac076a65","_tpl":"5ed515e03a40a50460332579","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":0,"y":0,"r":0,"isSearched":true}},{"_id":"65e1545b3c43423cb10a3ee9","_tpl":"5ed515c8d380ab312177c0fa","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":1,"y":2,"r":0,"isSearched":true}},{"_id":"65ee0aed288fc3162506bb28","_tpl":"637b620db7afa97bfc3d7009","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":1,"y":0,"r":0,"isSearched":true}},{"_id":"65ee30ef6bafe969ea03a231","_tpl":"5c0e530286f7747fa1419862","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":1,"y":1,"r":0,"isSearched":true}},{"_id":"65f39691676cb19f8511b96d","_tpl":"5ed515e03a40a50460332579","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":0,"y":1,"r":0,"isSearched":true}},{"_id":"65f3968a676cb19f8511b70e","_tpl":"5ed5160a87bb8443d10680b5","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":0,"y":2,"r":0,"isSearched":true}},{"_id":"65f3b3b01ec970f1b307a8e1","_tpl":"637b6179104668754b72f8f5","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":2,"y":1,"r":0,"isSearched":true}},{"_id":"65f3b3b4d6469e7e0706dd8b","_tpl":"5c0e533786f7747fa23f4d47","parentId":"65b039a82af2e547a20f46c7","slotId":"main","location":{"x":2,"y":0,"r":0,"isSearched":true}},{"_id":"65d1327fe20c7edb530e01a0","_tpl":"5751a89d24597722aa0e8db0","parentId":"658cd1cdaee208d8ed0878f9","slotId":"main","location":{"x":1,"y":0,"r":0,"isSearched":true},"upd":{"MedKit":{"HpResource":10}}},{"_id":"65de71cfda10f7eed905d2bd","_tpl":"5d02797c86f774203f38e30a","parentId":"658cd1cdaee208d8ed0878f9","slotId":"main","location":{"x":0,"y":0,"r":1,"isSearched":true},"upd":{"MedKit":{"HpResource":10}}},{"_id":"65f3aa2ca3260f69a01036bd","_tpl":"59e3577886f774176a362503","parentId":"658cd1cdaee208d8ed0878f9","slotId":"main","location":{"x":1,"y":1,"r":0,"isSearched":true},"upd":{"FoodDrink":{"HpPercent":70}}},{"_id":"65f35cd3046f110f66056dec","_tpl":"5c0fa877d174af02a012e1cf","parentId":"658cd1cdaee208d8ed0878f9","slotId":"main","location":{"x":2,"y":1,"r":0,"isSearched":true},"upd":{"FoodDrink":{"HpPercent":50}}},{"_id":"658cd1cdaee208d8ed087907","_tpl":"627a4e6b255f7527fb05a0f6","parentId":"658cd1cdaee208d8ed087909","slotId":"Pockets"},{"_id":"65f6561390c431ba71090c1e","_tpl":"5991b51486f77447b112d44f","parentId":"658cd1cdaee208d8ed087907","slotId":"SpecialSlot1"},{"_id":"65ef8815930d62722e0b99ee","_tpl":"5991b51486f77447b112d44f","parentId":"658cd1cdaee208d8ed087907","slotId":"SpecialSlot2"},{"_id":"65f3b442f909ab3c5303f021","_tpl":"5991b51486f77447b112d44f","parentId":"658cd1cdaee208d8ed087907","slotId":"SpecialSlot3"}]},"achievements":{"65141c30ec10ff011f17cc3b":1703803175,"65141c80ec10ff011f17cc3e":1703804521,"65141eb5c31fcb0e163577dd":1704048239,"65141e37cf2f1c285e606361":1705709784,"6512ea46f7a078264a4376e4":1706149834,"65141b9859647d2cb3213ca2":1706669541,"651419eea3dd9b6aa7159ee5":1708572669,"6513ee11a3dd9b6aa7159b4a":1708573000,"6512eb3ddfb0ae1ee75a0376":1710207057},"favoriteItems":[],"pmcStats":{"eft":{"totalInGameTime":7922117,"overAllCounters":{"Items":[{"Key":["Sessions","Pmc"],"Value":255},{"Key":["ExitStatus","Killed","Pmc"],"Value":118},{"Key":["Kills"],"Value":562},{"Key":["Deaths"],"Value":118},{"Key":["ExitStatus","Survived","Pmc"],"Value":134},{"Key":["LongestWinStreak","Pmc"],"Value":6},{"Key":["ExitStatus","Runner","Pmc"],"Value":3}]}}},"scavStats":{"eft":{"totalInGameTime":7922117,"overAllCounters":{"Items":[{"Key":["Sessions","Scav"],"Value":106},{"Key":["ExitStatus","Killed","Scav"],"Value":19},{"Key":["Kills"],"Value":3},{"Key":["Deaths"],"Value":19},{"Key":["ExitStatus","Survived","Scav"],"Value":87},{"Key":["LongestWinStreak","Scav"],"Value":17}]}}}}
*
*
* */

/*
* will be a static class that holds all references to DB paths needed
* */
import {Column, DataSource, Entity, PrimaryColumn, PrimaryGeneratedColumn} from "typeorm";
import {gql, request} from "graphql-request";
import {
    TarkovAchievement,
    TarkovItem,
    TarkovTask,
    TarkovTaskObjective,
    TarkovTaskReward,
    TarkovTrader, TarkovTraderBarter, TarkovTraderBarterRequirement, TarkovTraderCashOffer, TarkovTraderLevel
} from "./TarkovDataObjects";
import axios from "axios";

@Entity('profile_instance_header')
export class TarkovProfileInstanceHeader {

    // instance ID, created new when refreshing a profile
    @PrimaryGeneratedColumn('increment')
    iid: number

    // the AID of the profile being refreshed. We use the API integer key for this as its faster
    @PrimaryColumn()
    aid: number

    @Column({type: 'timestamp without time zone', name: 'logged_at', nullable: false})
    loggedAt: Date

    constructor(aid: number) {
        this.aid = aid;
        this.loggedAt = new Date();
    }
}

/*
* This will be the core 'profile' of a user, and what determines uniqueness of a user.
* */
@Entity('profile_header')
export class TarkovProfile {
    @PrimaryColumn()
    tid: string

    @Column({nullable: false})
    aid: number

    constructor(profile) {
        if (profile) {
            this.tid = profile.id;
            this.aid = profile.aid;
        }
    }

}

@Entity('profile_info')
export class TarkovProfileInstanceInfo {

    @PrimaryColumn()
    aid: number;

    @PrimaryColumn()
    iid: number

    @Column({nullable: false})
    nickname: string

    @Column({nullable: false})
    side: string

    @Column({nullable: false})
    experience: number

    @Column({nullable: false, name: 'member_category'})
    memberCategory: number

    @Column({nullable: false, name: 'banned_state'})
    bannedState: boolean

    @Column({nullable: false, name: 'banned_until'})
    bannedUntil: number

    @Column({nullable: false, name: 'registration_date'})
    registrationDate: Date

    constructor(aid: number, iid: number, info: any) {
        if (info) {
            this.aid = aid;
            this.iid = iid;
            this.nickname = info.nickname;
            this.side = info.side;
            this.experience = info.experience;
            this.memberCategory = info.memberCategory;
            this.bannedState = info.bannedState;
            this.bannedUntil = info.bannedUntil;
            this.registrationDate = new Date(info.registrationDate * 1000);
        }
    }
}

@Entity('profile_customization')
export class TarkovProfileInstanceCustomization {

    @PrimaryColumn()
    aid: number

    @PrimaryColumn()
    iid: number

    @Column({nullable: true})
    head: string

    @Column({nullable: true})
    body: string

    @Column({nullable: true})
    feet: string

    @Column({nullable: true})
    hands: string

    constructor(aid: number, iid: number, customization: any) {
        if (customization) {
            this.aid = aid;
            this.iid = iid;
            this.head = customization.head;
            this.body = customization.body;
            this.feet = customization.feet;
            this.hands = customization.hands;
        }
    }
}


@Entity('profile_achievement')
export class TarkovProfileInstanceAchievement {
    @PrimaryColumn()
    aid: number

    @PrimaryColumn()
    iid: number

    @PrimaryColumn()
    achid: string

    @Column({type: 'timestamp without time zone', nullable: false, name: 'logged_at'})
    loggedAt: Date

    constructor(aid: number, iid: number, ach: string, loggedAt: number) {
        if (aid) {
            this.aid = aid;
            this.iid = iid;
            this.achid = ach;
            this.loggedAt = new Date(loggedAt * 1000);
        }
    }

}

//
// //*
// // intended to reference a specific pull of data. This is a 'snapshot' of the profile at a specific time
// // *//
// @Entity('profile_instance')
// export class TarkovProfileInstance222 {
//
//     // internal ID representing the 'instance' of the scrape for data
//     // required so we can easily reference the same profile instance later
//     @PrimaryGeneratedColumn('uuid')
//     iid: string
//
//     // ID from tarkov - string, 24 characters. matches 'tid' on ProfileAchievement
//     @Column()
//     tid: string
//
//     // ID from tarkov.dev - their numerical ID
//     @Column({nullable: false})
//     aid: number
//
//     @Column({type: 'timestamp without time zone', name: 'logged_at', nullable: false})
//     loggedAt: Date
//
//     @Column({type: 'integer', name: 'total_in_game_time', nullable: false})
//     totalInGameTime: number
//
//     // nickname - can be changed in-game
//     @Column({nullable: false})
//     nickname: string
//
//     @Column({nullable: false})
//     experience: number
//
//     @Column({nullable: false, name: 'member_category'})
//     memberCategory: number
//
//     @Column({nullable: false, name: 'banned_state'})
//     bannedState: boolean
//
//     @Column({type: 'timestamp without time zone', nullable: false, name: 'registration_date'})
//     registrationDate: Date
//
//     @Column({nullable: true})
//     head: string
//
//     @Column({nullable: true})
//     body: string
//
//     @Column({nullable: true})
//     feet: string
//
//     @Column({nullable: true})
//     hands: string
//

//
//     @Column({type: 'integer', nullable: true, name: 'scav_sessions'})
//     scavSessions: number
//
//     @Column({type: 'integer', nullable: true, name: 'scav_deaths'})
//     scavDeaths: number
//
//     @Column({type: 'integer', nullable: true, name: 'scav_extracts'})
//     scavExtracts: number
//
//     @Column({type: 'integer', nullable: true, name: 'scav_runners'})
//     scavRunners: number
//
//     @Column({type: 'integer', nullable: true, name: 'scav_kills'})
//     scavKills: number
//
//     @Column({type: 'integer', nullable: true, name: 'scav_longest_win_streak'})
//     scavLongestWinStreak: number
// }

@Entity('profile_equipment_instance')
export class TarkovProfileInstanceEquipment {

    @PrimaryColumn()
    aid: number

    @PrimaryColumn()
    iid: number

    @PrimaryColumn()
    eid: string;

    @PrimaryColumn()
    tpl: string;

    @Column({nullable: true})
    parent: string

    @Column({nullable: true})
    slot: string

    constructor(aid: number, iid: number, eqRecord: any) {
        if (eqRecord) {
            this.aid = aid;
            this.iid = iid;
            this.eid = eqRecord._id;
            this.tpl = eqRecord._tpl;
            this.parent = eqRecord.parentId;
            this.slot = eqRecord.slotId;
        }
    }

}

@Entity('profile_skills_instance')
export class TarkovProfileInstanceCommonSkills {

    @PrimaryColumn()
    aid: number

    @PrimaryColumn()
    iid: number

    @PrimaryColumn()
    skill: string

    @Column({type: 'float'})
    progress: number

    @Column({type: 'float', name: 'points_earned_during_session'})
    pointsEarnedDuringSession: number

    @Column({type: 'timestamp without time zone', name: 'last_access'})
    lastAccess: Date

    constructor(aid: number, iid: number, data: any) {
        if (data) {
            this.aid = aid;
            this.iid = iid;
            this.skill = data.Id;
            this.progress = data.Progress;
            this.pointsEarnedDuringSession = data.PointsEarnedDuringSession;
            this.lastAccess = new Date(data.LastAccess);
        }
    }

}

@Entity('profile_mastery_instance')
export class TarkovProfileInstanceMasterySkills {

    @PrimaryColumn()
    aid: number

    @PrimaryColumn()
    iid: number

    @PrimaryColumn()
    skill: string

    @Column({type: 'integer'})
    progress: number

    constructor(aid: number, iid: number, data: any) {
        if (data) {
            this.aid = aid;
            this.iid = iid;
            this.skill = `${data.Id}`;
            this.progress = data.Progress;
        }
    }

}

@Entity('profile_pmc_counters')
export class TarkovProfileInstancePMCCounters {

    @PrimaryColumn()
    aid: number;

    @PrimaryColumn()
    iid: number;

    @Column({type: 'integer', name: 'total_in_game_time', nullable: false})
    totalInGameTime: number

    @Column({type: 'integer', nullable: true, name: 'pmc_sessions'})
    pmcSessions: number

    @Column({type: 'integer', nullable: true, name: 'pmc_deaths'})
    pmcDeaths: number

    @Column({type: 'integer', nullable: true, name: 'pmc_extracts'})
    pmcExtracts: number

    @Column({type: 'integer', nullable: true, name: 'pmc_runners'})
    pmcRunners: number

    @Column({type: 'integer', nullable: true, name: 'pmc_kills'})
    pmcKills: number

    @Column({type: 'integer', nullable: true, name: 'pmc_longest_win_streak'})
    pmcLongestWinStreak: number

    constructor(aid: number, iid: number, inGameTime: number, items: any[]) {
        if (items) {
            this.aid = aid;
            this.iid = iid;
            this.totalInGameTime = inGameTime;

            // we CANNOT assume the order of the items! Each field should grab the field based on the key value after mapping
            let mapItems = items.map((i) => {
                return {
                    key: i.Key.join('_'),
                    value: i.Value
                }
            })

            let psBuff = (mapItems.filter((i) => i.key.includes('Pmc') && i.key.includes('Sessions')))
            if (psBuff?.length > 0)
                this.pmcSessions = psBuff[0].value
            else
                this.pmcSessions = 0

            let pdBuff = (mapItems.filter((i) => i.key.includes('Pmc') && i.key.includes('Killed') && i.key.includes('ExitStatus')))
            if (pdBuff?.length > 0)
                this.pmcDeaths = pdBuff[0].value
            else
                this.pmcDeaths = 0

            let peBuff = (mapItems.filter((i) => i.key.includes('Pmc') && i.key.includes('Survived')))
            if (peBuff?.length > 0)
                this.pmcExtracts = peBuff[0].value
            else
                this.pmcExtracts = 0

            let prBuff = (mapItems.filter((i) => i.key.includes('Pmc') && i.key.includes('Runner')))
            if (prBuff?.length > 0)
                this.pmcRunners = prBuff[0].value
            else
                this.pmcRunners = 0

            let pkBuff = (mapItems.filter((i) => i.key.includes('Kills')))
            if (pkBuff?.length > 0)
                this.pmcKills = pkBuff[0].value
            else
                this.pmcKills = 0

            let pwBuff = (mapItems.filter((i) => i.key.includes('LongestWinStreak')))
            if (pwBuff?.length > 0)
                this.pmcLongestWinStreak = pwBuff[0].value
            else
                this.pmcLongestWinStreak = 0
        }
    }

}

@Entity('profile_scav_counters')
export class TarkovProfileInstanceScavCounters {

    @PrimaryColumn()
    aid: number;

    @PrimaryColumn()
    iid: number;

    @Column({type: 'integer', name: 'total_in_game_time', nullable: false})
    totalInGameTime: number

    @Column({type: 'integer', nullable: true, name: 'scav_sessions'})
    scavSessions: number

    @Column({type: 'integer', nullable: true, name: 'scav_deaths'})
    scavDeaths: number

    @Column({type: 'integer', nullable: true, name: 'scav_extracts'})
    scavExtracts: number

    @Column({type: 'integer', nullable: true, name: 'scav_kills'})
    scavKills: number

    @Column({type: 'integer', nullable: true, name: 'scav_longest_win_streak'})
    scavLongestWinStreak: number

    constructor(aid: number, iid: number, inGameTime: number, items: any[]) {
        if (items) {
            this.aid = aid;
            this.iid = iid;
            this.totalInGameTime = inGameTime;

            // we CANNOT assume the order of the items! Each field should grab the field based on the key value after mapping
            let mapItems = items.map((i) => {
                return {
                    key: i.Key.join('_'),
                    value: i.Value
                }
            })

            let ssBuff = (mapItems.filter((i) => i.key.includes('Scav') && i.key.includes('Sessions')))
            if (ssBuff?.length > 0)
                this.scavSessions = ssBuff[0].value
            else
                this.scavSessions = 0

            let sdBuff = (mapItems.filter((i) => i.key.includes('Scav') && i.key.includes('Killed') && i.key.includes('ExitStatus')))
            if (sdBuff?.length > 0)
                this.scavDeaths = sdBuff[0].value
            else
                this.scavDeaths = 0

            let seBuff = (mapItems.filter((i) => i.key.includes('Scav') && i.key.includes('Survived')))
            if (seBuff?.length > 0)
                this.scavExtracts = seBuff[0].value
            else
                this.scavExtracts = 0

            let skBuff = (mapItems.filter((i) => i.key.includes('Kills')))
            if (skBuff?.length > 0)
                this.scavKills = skBuff[0].value
            else
                this.scavKills = 0

            let swBuff = (mapItems.filter((i) => i.key.includes('LongestWinStreak')))
            if (swBuff?.length > 0)
                this.scavLongestWinStreak = swBuff[0].value
            else
                this.scavLongestWinStreak = 0
        }
    }

}

@Entity('tracker_request')
export class TarkovProfileManualRequest {
    // this table will be used to manually request a profile refresh by a user.
    // record is updated once the refresh is completed
    @PrimaryGeneratedColumn('uuid')
    rid: string

    // the user account that we want to track
    @Column({nullable: false})
    aid: number

    @Column({
        nullable: false,
        type: 'timestamp without time zone',
        name: 'requested_at',
        default: () => 'CURRENT_TIMESTAMP'
    })
    requestedAt: Date

    @Column({nullable: true, type: 'timestamp without time zone', name: 'completed_at'})
    completedAt: Date

    @Column({nullable: true, type: 'integer'})
    iid: number

    constructor(aid: number) {
        if (aid)
            this.aid = aid;
    }

}

@Entity('tracker_schedule')
export class TarkovProfileScheduledRequest {
    // this table will be used to request a profile over a schedule of time

    // the account that we want to track on a regular basis
    @PrimaryColumn()
    aid: number

    @Column({
        nullable: false,
        type: 'timestamp without time zone',
        name: 'last_request_at',
        default: () => 'CURRENT_TIMESTAMP'
    })
    lastRequestAt: Date

    // offset in minutes that we should force before the next refresh. default 15
    @Column({nullable: true, type: 'integer', name: 'minute_offset', default: 15})
    minuteOffset: number;


}

export class TarkovDatabase {

    static TarkovDB: DataSource;

    static async initialize() {
        TarkovDatabase.TarkovDB = new DataSource({
            name: 'cache',
            type: 'postgres',
            database: 'tarkov',
            schema: 'public',
            host: process.env.PG_HOST,
            port: parseInt(process.env.PG_PORT),
            username: process.env.PG_USER,
            password: process.env.PG_PASS,
            poolSize: 4,
            synchronize: true,
            entities: [TarkovAchievement, TarkovProfile, TarkovProfileInstanceAchievement,
                TarkovProfileInstanceHeader, TarkovProfileInstanceCustomization,
                TarkovProfileInstanceEquipment, TarkovProfileInstanceCommonSkills, TarkovProfileInstanceMasterySkills,
                TarkovProfileInstancePMCCounters, TarkovProfileInstanceScavCounters, TarkovProfileInstanceInfo,
                TarkovTrader, TarkovItem, TarkovProfileScheduledRequest, TarkovProfileManualRequest, TarkovTaskReward, TarkovTaskObjective, TarkovTask,
            TarkovTraderLevel, TarkovTraderBarter, TarkovTraderCashOffer, TarkovTraderBarterRequirement

            ]
        })
        await TarkovDatabase.TarkovDB.initialize();
        await TarkovDatabase.TarkovDB.synchronize(false);
        try {
            await TarkovDatabase.TarkovDB.query(`select null "rid", aid,
       last_request_at + (minute_offset * interval '1 minute') "next_request_at",
       last_request_at,
       true                                                    "isScheduled"
from tracker_schedule
union
select rid, aid, requested_at as "next_request_at", null "last_request_at", false
from tracker_request
where completed_at is null
order by next_request_at asc`);
        } catch (e) {
            console.error(e)
        }

    }

    private static async runGraphQuery(query: string) {
        let q = gql`${query}`;
        return await request('https://api.tarkov.dev/graphql', q)
    }

    private static async runPlayerQuery(pt: string) {
        return await axios.get(`https://player.tarkov.dev/${pt}`, {
            responseType: "json",
        })
    }

    static async refreshAchievements() {
        let res: {
            achievements: TarkovAchievement[]
        } = (await TarkovDatabase.runGraphQuery(`
            {
              achievements {  id, name, 
                description, hidden, 
                playersCompletedPercent, adjustedPlayersCompletedPercent, 
                side, normalizedSide, 
                rarity, normalizedRarity
              }
            }
        `) as {
            achievements: TarkovAchievement[]
        })

        // one by one, run an insert/update for each
        for (let a of res.achievements) {
            let achObj = new TarkovAchievement(a)
            await TarkovDatabase.TarkovDB.getRepository(TarkovAchievement).save(achObj)
        }

        return res?.achievements
    }

    static async refreshItems() {
        let res: {
            items: any[]
        } = (await TarkovDatabase.runGraphQuery(`{
  items {
    id
    name
    normalizedName
    shortName
    description
    basePrice
    updated
    width
    height
    iconLink
    gridImageLink
    baseImageLink
    inspectImageLink
    image512pxLink
    image8xLink
    wikiLink
    types
    avg24hPrice
    conflictingItems {
      id
    }
    conflictingSlotIds
    accuracyModifier
    recoilModifier
    ergonomicsModifier
    hasGrid
    blocksHeadphones
    link
    lastLowPrice
    changeLast48h
    changeLast48hPercent
    low24hPrice
    high24hPrice
    lastOfferCount
    sellFor {
      price
      priceRUB
      vendor {
        normalizedName
      }
      currencyItem {
        id
      }
    }
    containsItems {
      item {
        id
        name
      }
      quantity
      count
    }
    category {
      id
      name
    }
    bsgCategoryId
    weight
    velocity
    loudness
    craftsFor {
      id
      requiredItems {
        item {
          id
        }
        quantity
      }
      rewardItems {
        item {
          id
        }
        quantity
      }
      station {
        id,
      },
      level
    }
    craftsUsing {
      id
      requiredItems {
        item {
          id
          name
        }
        quantity
        count
        attributes {
          name
        }
      }
      rewardItems {
        item {
          id
          name
        }
        quantity
        count
        attributes {
          name
        }
      }
      station {
        id
        name
      }
    }
  }
}`) as {
            items: any[]
        })

        for (let i of res.items) {
            let item = new TarkovItem(i)
            await TarkovDatabase.TarkovDB.getRepository(TarkovItem).save(item)
        }

        return res.items
    }

    static async refreshTraders() {
        let res: {
            traders: any[]
        } = (await TarkovDatabase.runGraphQuery(`{ 
  traders {
    id
    name
    normalizedName
    description
    resetTime
    currency {
      id
    }

    discount
    levels {
      id
      level
      requiredPlayerLevel
      requiredReputation
      requiredCommerce
    }
    barters {
      level
      taskUnlock {
        id
      }
      requiredItems {
        item {
          id
        }
        quantity
      }
      rewardItems {
        item {
          id
        }
        quantity
      }
    }
    cashOffers {
      item {
        id
      }
      minTraderLevel
      taskUnlock {
        id
      }
      currencyItem {
        id
      }
      price
    }
    imageLink
    image4xLink
  }
}`) as {
            traders: any[]
        })

        for (let t of res?.traders) {
            let trader = new TarkovTrader(t)

            // save all trader related records now, from most detailed to least
            await TarkovDatabase.TarkovDB.getRepository(TarkovTraderBarterRequirement).save(trader.barters.map((b) => b.requirements).flat(1))
            await TarkovDatabase.TarkovDB.getRepository(TarkovTraderBarterRequirement).save(trader.barters.map((b) => b.rewards).flat(1))

            // save barters themselves
            await TarkovDatabase.TarkovDB.getRepository(TarkovTraderBarter).save(trader.barters.map((b, idx) => {
                b.bid = idx
                return b;
            }))

            // save trader levels
            await TarkovDatabase.TarkovDB.getRepository(TarkovTraderLevel).save(trader.levels)

            // save cash purchase options
            await TarkovDatabase.TarkovDB.getRepository(TarkovTraderCashOffer).save(trader.cashOffers)

            // save trader itself
            await TarkovDatabase.TarkovDB.getRepository(TarkovTrader).save(trader)

        }

        return res?.traders
    }

    static async refreshTasks() {
        let res: {
            tasks: any[]
        } = (await TarkovDatabase.runGraphQuery(`{
  tasks {
    id
    name
    normalizedName
    trader {
      id
    }
    map {
      id
    }
    experience
    wikiLink
    taskImageLink
    minPlayerLevel
    taskRequirements {
      task {
        id
      }
      status
    }
    traderRequirements {
      trader {
        id
      }
      id
      value
    }
    objectives {
      id
      description
      optional
      type
      maps {
        id
      }
    }
    startRewards {
      items {
        item {
          id
        }
        quantity
      }
      traderUnlock {
        id
      }
      traderStanding {
        standing
      }
      offerUnlock {
        id
      }
      craftUnlock {
        id
      }
    }
    finishRewards {
      items {
        item {
          id
        }
        quantity
      }
      traderUnlock {
        id
      }
      traderStanding {
        standing
      }
      offerUnlock {
        id
      }
      craftUnlock {
        id
      }
    }
    failureOutcome {
      items {
        item {
          id
        }
        quantity
      }
      traderUnlock {
        id
      }
      traderStanding {
        standing
      }
      offerUnlock {
        id
      }
      craftUnlock {
        id
      }
    }
    failConditions {
      description
      optional
    }
    restartable
    factionName
    kappaRequired
    lightkeeperRequired
    startMessageId
    successMessageId
    failMessageId
    descriptionMessageId
  }
}`) as {
            tasks: any[]
        })

        for (let t of res.tasks) {
            let task = new TarkovTask(t)
            await TarkovDatabase.TarkovDB.getRepository(TarkovTaskObjective).save(task.objectives);
            await TarkovDatabase.TarkovDB.getRepository(TarkovTaskReward).save(task.rewards);
            await TarkovDatabase.TarkovDB.getRepository(TarkovTask).save(task);
        }

        return res.tasks;
    }

    static async refreshCrafts() {
        let res: {
            crafts: any[]
        } = (await TarkovDatabase.runGraphQuery(`{
  crafts{
    id,
    station {
      id,
      name
    },
    level,
    taskUnlock{id},
    duration,
    requiredItems{
      item{id},quantity
    },
    requiredQuestItems{
      id
    },
    rewardItems{
      item{id},quantity
    }
  }
}`) as {
            crafts: any[]
        })

        return res.crafts;
    }

    static async bulkSaveEquipment(equipList: TarkovProfileInstanceEquipment[]) {
        while (equipList.length > 0) {
            // save equip data by splitting up by 100 records at a time
            let saveList = equipList.slice(0, 100)
            await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstanceEquipment).save(saveList)

            if (equipList.length > 0)
                equipList = equipList.slice(100)
            else
                equipList = []
        }
    }

    static async bulkSaveCommonSkills(skillList: TarkovProfileInstanceCommonSkills[]) {
        while (skillList.length > 0) {
            // save equip data by splitting up by 100 records at a time
            let saveList = skillList.slice(0, 100)
            await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstanceCommonSkills).save(saveList)

            if (skillList.length > 0)
                skillList = skillList.slice(100)
            else
                skillList = []
        }
    }

    static async bulkSaveMasterySkills(skillList: TarkovProfileInstanceMasterySkills[]) {
        while (skillList.length > 0) {
            // save equip data by splitting up by 100 records at a time
            let saveList = skillList.slice(0, 100)
            await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstanceMasterySkills).save(saveList)

            if (skillList.length > 0)
                skillList = skillList.slice(100)
            else
                skillList = []
        }
    }

    // passed in AID (account id) from tarkov.dev
    // can be gotten from the username search
    static async refreshProfile(aid: number) {
        // first, lets create a 'refresh instance' before calling the API
        let instance = new TarkovProfileInstanceHeader(aid)

        // query the DB. if we successfully get a profile, we can then save the instance
        let res = await TarkovDatabase.runPlayerQuery(`account/${aid}`)
        if (res.status != 200)
            throw new Error(res.statusText)

        // make sure the profile itself is saved
        let profile = new TarkovProfile(res.data)
        await TarkovDatabase.TarkovDB.getRepository(TarkovProfile).save(profile)

        // save the instance, we did get some player data
        // we can now use the instance.iid to save any future profile data
        instance = await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstanceHeader).save(instance)

        // now we can save the rest of the profile data
        let info = new TarkovProfileInstanceInfo(aid, instance.iid, res.data.info);
        await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstanceInfo).save(info)

        // save the customization data (head through feet)
        let cust = new TarkovProfileInstanceCustomization(aid, instance.iid, res.data.customization);
        await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstanceCustomization).save(cust)

        // save skills data
        // common first
        let commonSkillIst = [];
        for (let sk of res.data.skills?.Common) {
            let skill = new TarkovProfileInstanceCommonSkills(aid, instance.iid, sk);
            commonSkillIst.push(skill);
        }
        await TarkovDatabase.bulkSaveCommonSkills(commonSkillIst);

        // mastery next
        let masterySkillList = [];
        for (let mk of res.data.skills?.Mastering) {
            let skill = new TarkovProfileInstanceMasterySkills(aid, instance.iid, mk);
            masterySkillList.push(skill);
        }
        await TarkovDatabase.bulkSaveMasterySkills(masterySkillList);

        // save the equipment data
        let equipSaveList = [];
        for (let eq of res.data.equipment?.Items) {
            let equip = new TarkovProfileInstanceEquipment(aid, instance.iid, eq);
            equipSaveList.push(equip);
        }
        await TarkovDatabase.bulkSaveEquipment(equipSaveList);

        let achKeys = Object.keys(res.data.achievements)
        // save achievements
        for (let ach of achKeys) {
            let achObj = new TarkovProfileInstanceAchievement(aid, instance.iid, ach, res.data.achievements[ach]);
            await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstanceAchievement).save(achObj);
        }

        // save PMC stats
        let pmcCounters: any[] = res.data?.pmcStats?.eft?.overAllCounters?.Items;
        let pmcTime: number = res.data?.pmcStats?.eft?.totalInGameTime;
        let pmc = new TarkovProfileInstancePMCCounters(aid, instance.iid, pmcTime, pmcCounters);
        await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstancePMCCounters).save(pmc);

        // save Scav stats
        let scavCounters: any[] = res.data?.scavStats?.eft?.overAllCounters?.Items;
        let scavTime: number = res.data?.scavStats?.eft?.totalInGameTime;
        let scav = new TarkovProfileInstanceScavCounters(aid, instance.iid, scavTime, scavCounters);
        await TarkovDatabase.TarkovDB.getRepository(TarkovProfileInstanceScavCounters).save(scav);
        return instance;
    }

    static async searchProfile(partialString: string): Promise<{ aid: string, name: string }[]> {
        let res = await TarkovDatabase.runPlayerQuery(`name/${partialString}`)
        if (res.status === 200) {
            return res.data
        } else
            throw new Error(res.statusText)
    }

    static async refreshCoreData() {
        await TarkovDatabase.refreshAchievements()
        await TarkovDatabase.refreshTraders();
        await TarkovDatabase.refreshItems();
        await TarkovDatabase.refreshTasks();
        //await TarkovDatabase.refreshCrafts();
    }

    static async updateScheduledRequest(aid: number) {
        return await TarkovDatabase.TarkovDB.query('call update_scheduled_request($1)', [aid])
    }

    static async updateManualRequest(rid: string, iid: number) {
        return await TarkovDatabase.TarkovDB.query('call update_manual_request($1, $2)', [rid, iid])
    }

    static async updateManualRequestFailed(rid: string) {
        return await TarkovDatabase.TarkovDB.query('call update_manual_request_failed($1)', [rid])
    }

    static async getNextRequest(): Promise<{
        rid?: string,
        aid: number,
        next_request_at: Date,
        last_request_at?: Date,
        isScheduled: boolean
    }> {
        let r = await TarkovDatabase.TarkovDB.query('select * from public.request_list_view limit 1');
        if (r && r.length > 0) {
            return r[0];
        }
    }

}

